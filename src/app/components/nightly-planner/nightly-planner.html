<!-- Nightly Planner Modal -->
@if (isOpen()) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 w-full max-w-2xl max-h-[90vh] overflow-hidden">
      
      <!-- Header -->
      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold">üåô Nightly Planning</h2>
            <p class="text-indigo-100 text-sm">Reflect on today and prepare for tomorrow</p>
          </div>
          <button (click)="closePlanner()" class="text-white/80 hover:text-white text-2xl">
            ‚úï
          </button>
        </div>
        
        <!-- Progress Steps -->
        <div class="mt-6">
          <div class="flex items-center justify-between text-sm">
            @for (step of [1,2,3,4,5]; track step) {
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
                     [class.bg-white]="currentStep() >= step"
                     [class.text-indigo-600]="currentStep() >= step"
                     [class.bg-indigo-400]="currentStep() < step"
                     [class.text-white]="currentStep() < step">
                  {{ step }}
                </div>
                @if (step < 5) {
                  <div class="w-8 h-0.5 mx-2"
                       [class.bg-white]="currentStep() > step"
                       [class.bg-indigo-400]="currentStep() <= step"></div>
                }
              </div>
            }
          </div>
          <div class="mt-2 text-center">
            <span class="text-indigo-100 font-medium">{{ getStepTitle(currentStep()) }}</span>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 overflow-y-auto max-h-[60vh]">
        
        <!-- Step 1: Daily Reflection -->
        @if (currentStep() === 1) {
          <div class="space-y-6">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-slate-800 mb-2">How was your day?</h3>
              <p class="text-slate-600">Let's reflect on what happened today</p>
            </div>

            <!-- Today's Habits Summary -->
            <div class="bg-slate-50 rounded-xl p-4 mb-6">
              <h4 class="font-medium text-slate-800 mb-2">üìä Today's Habits</h4>
              <div class="flex items-center gap-4">
                <div class="text-2xl font-bold text-green-600">
                  {{ getTodaysHabitSummary().completed }}/{{ getTodaysHabitSummary().total }}
                </div>
                <div class="text-sm text-slate-600">
                  habits completed today
                </div>
              </div>
            </div>

            <!-- Accomplishments -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üéâ What did you accomplish today?
              </label>
              <div class="space-y-2 mb-3">
                @for (accomplishment of getAccomplishments(); track $index) {
                  <div class="flex items-center gap-2 bg-green-50 text-green-800 px-3 py-2 rounded-lg">
                    <span class="flex-1">{{ accomplishment }}</span>
                    <button (click)="removeAccomplishment($index)" class="text-green-600 hover:text-green-800">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
              <div class="flex gap-2">
                <input [(ngModel)]="newAccomplishment" 
                       (keyup.enter)="addAccomplishment()"
                       placeholder="I completed my morning workout..."
                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button (click)="addAccomplishment()" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                  Add
                </button>
              </div>
            </div>

            <!-- Challenges -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üí™ What challenges did you face?
              </label>
              <div class="space-y-2 mb-3">
                @for (challenge of plan()?.dailyReflection.challenges || []; track $index) {
                  <div class="flex items-center gap-2 bg-orange-50 text-orange-800 px-3 py-2 rounded-lg">
                    <span class="flex-1">{{ challenge }}</span>
                    <button (click)="removeChallenge($index)" class="text-orange-600 hover:text-orange-800">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
              <div class="flex gap-2">
                <input [(ngModel)]="newChallenge" 
                       (keyup.enter)="addChallenge()"
                       placeholder="I struggled with staying focused..."
                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button (click)="addChallenge()" 
                        class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                  Add
                </button>
              </div>
            </div>

            <!-- Lessons Learned -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üß† What did you learn today?
              </label>
              <textarea [(ngModel)]="plan()!.dailyReflection.lessonsLearned"
                        (ngModelChange)="updateLessonsLearned($event)"
                        placeholder="Today I learned that..."
                        rows="3"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </textarea>
            </div>
          </div>
        }

        <!-- Step 2: Gratitude & Mood -->
        @if (currentStep() === 2) {
          <div class="space-y-6">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-slate-800 mb-2">Gratitude & Mood</h3>
              <p class="text-slate-600">Capture the positive moments and how you feel</p>
            </div>

            <!-- Gratitude -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üôè What are you grateful for today?
              </label>
              <div class="space-y-2 mb-3">
                @for (gratitude of plan()?.dailyReflection.gratitude || []; track $index) {
                  <div class="flex items-center gap-2 bg-yellow-50 text-yellow-800 px-3 py-2 rounded-lg">
                    <span class="flex-1">{{ gratitude }}</span>
                    <button (click)="removeGratitude($index)" class="text-yellow-600 hover:text-yellow-800">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
              <div class="flex gap-2">
                <input [(ngModel)]="newGratitude" 
                       (keyup.enter)="addGratitude()"
                       placeholder="I'm grateful for my health..."
                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button (click)="addGratitude()" 
                        class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                  Add
                </button>
              </div>
            </div>

            <!-- Energy Level -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-3">
                ‚ö° How was your energy level today?
              </label>
              <div class="bg-slate-50 rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-slate-600">Very Low</span>
                  <span class="text-sm font-medium text-slate-800">
                    {{ plan()?.dailyReflection.energyLevel || 5 }}/10 - {{ getEnergyLevelText(plan()?.dailyReflection.energyLevel || 5) }}
                  </span>
                  <span class="text-sm text-slate-600">Excellent</span>
                </div>
                <input type="range" 
                       min="1" 
                       max="10" 
                       [value]="plan()?.dailyReflection.energyLevel || 5"
                       (input)="updateEnergyLevel(+$any($event.target).value)"
                       class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider">
              </div>
            </div>

            <!-- Mood -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-3">
                üòä How are you feeling overall?
              </label>
              <div class="grid grid-cols-5 gap-2">
                @for (mood of [
                  {value: 'great', emoji: 'üåü', label: 'Great'}, 
                  {value: 'good', emoji: 'üòä', label: 'Good'}, 
                  {value: 'okay', emoji: 'üòê', label: 'Okay'}, 
                  {value: 'challenging', emoji: 'üò¨', label: 'Challenging'}, 
                  {value: 'difficult', emoji: 'üò∞', label: 'Difficult'}
                ]; track mood.value) {
                  <button (click)="updateMood($any(mood.value))"
                          class="p-3 rounded-xl border-2 transition-all text-center"
                          [class.border-indigo-500]="plan()?.dailyReflection.mood === mood.value"
                          [class.bg-indigo-50]="plan()?.dailyReflection.mood === mood.value"
                          [class.border-slate-200]="plan()?.dailyReflection.mood !== mood.value">
                    <div class="text-xl mb-1">{{ mood.emoji }}</div>
                    <div class="text-xs text-slate-600">{{ mood.label }}</div>
                  </button>
                }
              </div>
            </div>
          </div>
        }

        <!-- Step 3: Tomorrow's Plan -->
        @if (currentStep() === 3) {
          <div class="space-y-6">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-slate-800 mb-2">Tomorrow's Plan</h3>
              <p class="text-slate-600">Set yourself up for success</p>
            </div>

            <!-- Top Priorities -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üéØ What are your top 3-5 priorities for tomorrow?
              </label>
              <div class="space-y-2 mb-3">
                @for (priority of plan()?.tomorrowsPlan.topPriorities || []; track $index) {
                  <div class="flex items-center gap-2 bg-blue-50 text-blue-800 px-3 py-2 rounded-lg">
                    <span class="font-medium">{{ $index + 1 }}.</span>
                    <span class="flex-1">{{ priority }}</span>
                    <button (click)="removePriority($index)" class="text-blue-600 hover:text-blue-800">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
              <div class="flex gap-2">
                <input [(ngModel)]="newPriority" 
                       (keyup.enter)="addPriority()"
                       placeholder="Complete the project proposal..."
                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button (click)="addPriority()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  Add
                </button>
              </div>
            </div>

            <!-- Focus Area -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üîç What's your main focus area for tomorrow?
              </label>
              <input [(ngModel)]="plan()!.tomorrowsPlan.focusArea"
                     (ngModelChange)="updateFocusArea($event)"
                     placeholder="Deep work on creative projects..."
                     class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Energy Plan -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                ‚ö° How will you manage your energy tomorrow?
              </label>
              <textarea [(ngModel)]="plan()!.tomorrowsPlan.energyPlan"
                        (ngModelChange)="updateEnergyPlan($event)"
                        placeholder="Start with my most important task when I'm fresh in the morning..."
                        rows="3"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </textarea>
            </div>
          </div>
        }

        <!-- Step 4: Sleep Planning -->
        @if (currentStep() === 4) {
          <div class="space-y-6">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-slate-800 mb-2">Sleep Planning</h3>
              <p class="text-slate-600">Prepare for quality rest and recovery</p>
            </div>

            <!-- Sleep Schedule -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  üõèÔ∏è Bedtime
                </label>
                <input type="time" 
                       [value]="plan()?.sleepPlan.bedtime || '22:00'"
                       (input)="updateBedtime($any($event.target).value)"
                       class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  ‚òÄÔ∏è Wake Time
                </label>
                <input type="time" 
                       [value]="plan()?.sleepPlan.wakeTime || '07:00'"
                       (input)="updateWakeTime($any($event.target).value)"
                       class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
            </div>

            <!-- Sleep Routine -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üåô Bedtime Routine
              </label>
              <div class="space-y-2 mb-3">
                @for (item of plan()?.sleepPlan.routine || []; track $index) {
                  <div class="flex items-center gap-2 bg-purple-50 text-purple-800 px-3 py-2 rounded-lg">
                    <span class="flex-1">{{ item }}</span>
                    <button (click)="removeRoutineItem($index)" class="text-purple-600 hover:text-purple-800">
                      ‚úï
                    </button>
                  </div>
                }
              </div>
              <div class="flex gap-2">
                <input [(ngModel)]="newRoutineItem" 
                       (keyup.enter)="addRoutineItem()"
                       placeholder="Read for 15 minutes..."
                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button (click)="addRoutineItem()" 
                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                  Add
                </button>
              </div>
            </div>

            <!-- Sleep Environment -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                üè† Sleep Environment Notes
              </label>
              <textarea [(ngModel)]="plan()!.sleepPlan.environment"
                        (ngModelChange)="updateEnvironment($event)"
                        placeholder="Cool room, blackout curtains, phone in another room..."
                        rows="2"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </textarea>
            </div>
          </div>
        }

        <!-- Step 5: Review & Save -->
        @if (currentStep() === 5) {
          <div class="space-y-6">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-slate-800 mb-2">Review Your Plan</h3>
              <p class="text-slate-600">Everything looks good? Let's save your nightly plan!</p>
            </div>

            <!-- Summary Cards -->
            <div class="grid gap-4">
              <!-- Reflection Summary -->
              <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4">
                <h4 class="font-medium text-slate-800 mb-2">üìù Today's Reflection</h4>
                <div class="text-sm text-slate-600 space-y-1">
                  <div>{{ (plan()?.dailyReflection.accomplishments || []).length }} accomplishments</div>
                  <div>{{ (plan()?.dailyReflection.gratitude || []).length }} gratitude entries</div>
                  <div>Energy: {{ plan()?.dailyReflection.energyLevel }}/10</div>
                  <div>Mood: {{ getMoodEmoji(plan()?.dailyReflection.mood || 'okay') }} {{ plan()?.dailyReflection.mood }}</div>
                </div>
              </div>

              <!-- Tomorrow's Plan Summary -->
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4">
                <h4 class="font-medium text-slate-800 mb-2">üéØ Tomorrow's Plan</h4>
                <div class="text-sm text-slate-600 space-y-1">
                  <div>{{ (plan()?.tomorrowsPlan.topPriorities || []).length }} priorities set</div>
                  <div>Focus: {{ plan()?.tomorrowsPlan.focusArea || 'Not specified' }}</div>
                </div>
              </div>

              <!-- Sleep Plan Summary -->
              <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4">
                <h4 class="font-medium text-slate-800 mb-2">üõèÔ∏è Sleep Plan</h4>
                <div class="text-sm text-slate-600 space-y-1">
                  <div>Bedtime: {{ plan()?.sleepPlan.bedtime }}</div>
                  <div>Wake time: {{ plan()?.sleepPlan.wakeTime }}</div>
                  <div>{{ (plan()?.sleepPlan.routine || []).length }} routine items</div>
                </div>
              </div>
            </div>

            <!-- Planning Streak -->
            <div class="bg-yellow-50 rounded-xl p-4 text-center">
              <div class="text-2xl font-bold text-yellow-600">{{ getPlanningStreak() }}</div>
              <div class="text-sm text-yellow-700">day planning streak! üéâ</div>
            </div>
          </div>
        }
      </div>

      <!-- Footer -->
      <div class="bg-slate-50 px-6 py-4 flex items-center justify-between border-t border-slate-200">
        <button (click)="previousStep()" 
                [disabled]="currentStep() === 1"
                class="px-4 py-2 text-slate-600 hover:text-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
          ‚Üê Previous
        </button>
        
        <div class="text-sm text-slate-500">
          Step {{ currentStep() }} of {{ totalSteps }}
        </div>
        
        @if (currentStep() < totalSteps) {
          <button (click)="nextStep()" 
                  [disabled]="!canProceedToNextStep()"
                  class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
            Next ‚Üí
          </button>
        } @else {
          <button (click)="savePlan()" 
                  class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            üíæ Save Plan
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- Floating Action Button to Open Planner -->
@if (!isOpen()) {
  <button (click)="openPlanner()" 
          class="fixed bottom-24 right-6 w-14 h-14 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center justify-center text-xl z-40">
    üåô
  </button>
}